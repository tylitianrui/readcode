# tsdb
todo : 本章主要讲解`tsdb`   

## 简述

### 时序数据

按照时间顺序记录的数据，就是时序数据，例如某人每顿吃几碗饭、每天的气温、cup使用率等  

例如:两台物理机(a,b)它们的cup使用率
```    
    │ 
    │ 
  a │       10%          12%         10%          6%          50%
    │ 
  b │        6%          8%           12%          8%          3%
    │ 
    └───────────────────────────────────────────────────────────────────>
            12:00        12:01       12:02       12:03        12:04      time

```

机器a的`cup使用率`，可以统计成

``` 
  a ->  (12:00, 10%),(12:01, 12%),(12:02, 10%),(12:03, 6%),(12:04, 50%) , ......
```

一般,时序数据可以看成

```
 identifier  -> (t1,v1),(t2,v2),(t3,v3),(t4,v4), ... 
```  

时序数据库特点:  

-  数据以**时间推进**而产生  
- 数据无需更新。 
- 本质是一系列的`K-V`数据`(t,value)`, `key`为时间，`value`就是记录的数据。

### prometheus data model
 
**`metric name`与`label`**

格式：
```
<metric name>{<label name>=<label value>, ...} 
```
例如：`prometheus`拉取target的指标时，获取到的原始数据，如下：
```
tyltr_request_total{code="200",method="GET",path="/ping/1"} 1
tyltr_request_total{code="404",method="POST",path="/pingq"} 34
tyltr_request_total{code="404",method="POST",path="/XXXXX"} 5
tyltr_request_total{code="404",method="GET",path="/pingq"} 2
```
说明
-  `metric name`:  `tyltr_request_total`
-  `label`: `code`、`method`、`path`


`prometheus`会将`metric name`与`label`解析成如下格式： 
```
{__name__="tyltr_request_total",code="200",method="GET",path="/ping/1"} 
{__name__="tyltr_request_total",code="404",method="POST",path="/pingq"} 
{__name__="tyltr_request_total",code="404",method="POST",path="/XXXXX"} 
{__name__="tyltr_request_total",code="404",method="GET",path="/pingq"}

```

<details>
  <summary>注: 解析过程</summary>
  
  ###  函数调用链

`func (sl *scrapeLoop) scrapeAndReport(last, appendTime time.Time, errc chan<- error) time.Time `     -->     `func (sl *scrapeLoop) append(app storage.Appender, b []byte, contentType string, ts time.Time) (total, added, seriesAdded int, err error) `     -->    **`p.Metric(&lset) ` 解析 metrics 数据**   -->   `lset = sl.sampleMutator(lset)`设置最终的label


**p.Metric(&lset)  解析获取到的metrics数据**

详见[解析metric](004.scrape.md)

</details>

最终，一组指标解析成下面的数据： 

```
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="200",method="GET",path="/ping/1"}    1711809974984          1
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="POST",path="/pingq"}    1711810012158         34
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="POST",path="/XXXXX"}    1711810012158          5
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="GET",path="/pingq" }    1711810032980          2

 |_____________________________|  |_________________________________________________________________________________|     |___________|        |___|
        metric name                                                lables                                                    timestamp       sample value

 |_____________________________________________________________________________________________________________________________________|       |___|
                                      带有时间属性的key                                                                                           value

```

上述的监控指标，通过二维坐标可以表示成 

```                                                                                                                     
                                                                                                                         ^  series
                                                                                                                         │  
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="200",method="GET",path="/ping/1"}   │          1                 .                                                  .             .
                                                                                                                         │             
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="POST",path="/pingq"}   │          .                 34                  .               .                           
                                                                                                                         │            
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="POST",path="/XXXXX"}   │          .                 5                   .               .               .             . 
                                                                                                                         │             
{ __name__="tyltr_request_total", instance="127.0.0.1:9100", job="prom_target",code="404",method="GET",path="/pingq" }   │          .                 .                   2                                           
                                                                                                                         │             
                                                                                                                         └── ~ ───────────────────────────────────────────────────────────────────────────────────────────────────>
                                                                                                                              1711809974984        1711810012158       1711810032980      ..             ..             ..     timestamp


```

<!-- 
  1. label越多需要的存储序列就把会越多
  2. 有的指标可能会突然消失，然后一段时间恢复。例如短暂的宕机或者进程发布而造成的进程关闭、重启
  3. 云原生的场景下，有的pod关闭，有的重新拉起，那么label的值就可能出现变化，虽然提供的是同一个服务，但标签却发生了变化
 -->




## TSDB版本变迁
TODO  




## TSDB V3
TODO  

